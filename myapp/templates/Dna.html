<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<style>
    /* .grid-column-3-width {
    } */

    .cam {
        display: grid;
        grid-template-columns: auto 300px;
        gap: 20px;
    }

    .capture-side {
        background-color: #e6e6e3;
        padding: 20px;
    }

    .capture-side form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .capture-side label {
        font-weight: bold;
    }

    .capture-side input {
        width: 100%;
        padding: 5px;
    }

    .img-sperm {
        width: 100%;
        height: 90%;
        max-height: 700px;
    }

    .capture {
        margin-top: 10px;
        padding: 5px 10px;
    }

    /* .cam-screen {
        width: 1280px;
        height: 720px;
    } */
</style>

<body>

    <div class="cam overflow-hidden text-red-900">
        <div>
            <img id="imgSperm" class="img-sperm" src="">
        </div>
        <div class="capture-side">
            <button id="uploadBtn"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Browse</button>
            <button id="snap" onclick="captureImage()"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Capture</button>
            <button id="detectCameraBtn"
                class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Detect Camera</button>
            <input type="file" id="fileInput" class="hidden" />
            <div alig="center">
                <form action="https://www.rssdinfotech.com/prime/1.php" method="post" enctype="multipart/form-data"
                    name="addroom" name="addroom">
                    <label for="TotalSpermCount">Total DNA:</label>
                    <input type="number" class="capture" id="TotalSpermCount" name="total"
                        placeholder="Enter Total Sperm Count" required>

                    <label for="HighSpeedSpermCount">Big Hallow:</label>
                    <input type="number" class="capture" id="HighSpeedSpermCount" name="a"
                        placeholder="Enter High Speed Sperm Count" required>

                    <label for="MediumSpeedSpermCount">Medium Hallow:</label>
                    <input type="number" class="capture" id="MediumSpeedSpermCount" name="b"
                        placeholder="Enter Medium Speed Sperm Count" required>

                    <label for="LowSpeedSpermCount">Small Hallow:</label>
                    <input type="number" class="capture" id="LowSpeedSpermCount" name="c"
                        placeholder="Enter Low Speed Sperm Count" required>

                    <label for="DustSpermCount">Dust Hallow:</label>
                    <input type="number" class="capture" id="DustSpermCount" name="c"
                        placeholder="Enter Dust Sperm Count" required>

                    <input type="submit" class="capture" name="submit">
                </form>
            </div>
        </div>
    </div>
    <script>

        const uploadBtn = document.getElementById("uploadBtn");
        let socket = null;
        document.getElementById("fileInput").addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                updateImage(file);
                if (file) {
                    updateImage(file);
                    if (socket) {
                        socket.disconnect(); // Disconnect the socket if it's open
                        socket = null;
                        detectCameraBtn.textContent = "Detect Camera"; // Reset button text
                    }
                }
            }
        });
        document.getElementById("uploadBtn").addEventListener("click", () => {
            document.getElementById("fileInput").click();
        });

        document.getElementById('detectCameraBtn').addEventListener('click', function () {
            if (!socket) {
                // Start the camera detection
                socket = io.connect('http://localhost:5000');
                socket.on('image_frame', function (data) {
                    imgElement.src = 'data:image/jpeg;base64,' + data.image;
                });
            } else {
                // Stop the camera detection
                socket.disconnect();
                socket = null;
                detectCameraBtn.textContent = "Detect Camera"; // Reset button text
            }
        });

        function captureImage() {
            const imgElement = document.getElementById("imgSperm");
            fetch(imgElement.src)
                .then(response => response.blob())
                .then(blob => {
                    const formData = new FormData();
                    formData.append('image', blob);
                    fetch('/process_image_dna', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            const imgElement = document.getElementById("imgSperm");
                            imgElement.src = data.imageData;
                            document.getElementById("TotalSpermCount").value = data.halo_counts.total;
                            document.getElementById("HighSpeedSpermCount").value = data.halo_counts.big;
                            document.getElementById("MediumSpeedSpermCount").value = data.halo_counts.medium;
                            document.getElementById("LowSpeedSpermCount").value = data.halo_counts.small;
                            document.getElementById("DustSpermCount").value = data.halo_counts.dead;

                            // Change code here
                            fetch(imgElement.src)
                                .then(response => response.blob())
                                .then(blob => {
                                    const formData = new FormData();
                                    formData.append('image', blob, 'capture.png');
                                    // Add additional data here
                                    formData.append('totalSpermCount', document.getElementById("TotalSpermCount").value);
                                    formData.append('highSpeedSpermCount', document.getElementById("HighSpeedSpermCount").value);
                                    // More fields can be added similarly
                                    fetch('/upload-image', {
                                        method: 'POST',
                                        body: formData
                                    })
                                        .then(response => response.json())
                                        .then(data => console.log('Success:', data))
                                        .catch(error => console.error('Error:', error));
                                })
                                .catch(error => {
                                    console.error('Error fetching image:', error);
                                });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                })
                .catch(error => {
                    console.error('Error fetching image:', error);
                });
        }

        function updateImage(file) {
            const imgElement = document.getElementById("imgSperm");
            const reader = new FileReader();
            reader.onload = function (e) {
                imgElement.src = e.target.result;
                // Clear the previously displayed counts when a new image is loaded
                document.getElementById("TotalSpermCount").value = '';
                document.getElementById("HighSpeedSpermCount").value = '';
                document.getElementById("MediumSpeedSpermCount").value = '';
                document.getElementById("LowSpeedSpermCount").value = '';
                document.getElementById("DustSpermCount").value = '';
            }
            reader.readAsDataURL(file);
        }

    </script>
</body>

</html>